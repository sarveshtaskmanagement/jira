<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Tickets Status</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Atlassian Sans", ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }


        .container {
            width: 100%;
            margin: 0;
            background: white;
            overflow: hidden;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            max-width: 50%;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        .text-input {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .text-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .action-btn {
            background: #1868DB;
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            white-space: nowrap;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 104, 219, 0.4);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            color: #666;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1868DB;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border-left: 4px solid #c33;
        }

        .error.active {
            display: block;
        }

        .tickets-container {
            padding: 30px;
            overflow-x: auto;
        }

        .ticket-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ticket-key {
            font-size: 1.2em;
            font-weight: 600;
            color: #1868DB;
        }

        .ticket-status {
            font-weight: 600;
            color: #444;
        }

        .ticket-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }

        .ticket-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: #666;
        }

        .tab-bar {
            display: flex;
            gap: 0;
            padding: 0 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 18px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
        }

        .tab-btn:hover {
            color: #444;
            background: rgba(24, 104, 219, 0.06);
        }

        .tab-btn.active {
            color: #1868DB;
            border-bottom-color: #1868DB;
            background: rgba(24, 104, 219, 0.12);
        }


        .tickets-table {
            width: 100%;
            min-width: 1100px;
            border-collapse: collapse;
        }

        .tickets-table th, .tickets-table td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            font-size: 14px;
        }

        .tickets-table th {
            background: rgba(24, 104, 219, 0.12);
            font-weight: 700;
            color: #444;
            white-space: nowrap;
        }

        .tickets-table tbody tr:hover {
            background: rgba(24, 104, 219, 0.06);
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sorted {
            background: rgba(24, 104, 219, 0.12);
            color: #1868DB;
        }

        .sort-indicator {
            margin-left: 6px;
            font-size: 11px;
            color: #888;
        }

        .filter-actions {
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
        }

        .clear-btn {
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }

        .clear-btn:hover {
            background: rgba(24, 104, 219, 0.08);
            border-color: #1868DB;
            color: #444;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .dash-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dash-grid {
                grid-template-columns: 1fr;
            }
        }

        .dash-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .dash-card h3 {
            margin-bottom: 12px;
            color: #444;
        }

        .dash-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .dash-list li {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .dash-list li span:last-child {
            text-align: right;
        }

        .dash-list li:last-child {
            border-bottom: none;
        }

        .dash-section {
            margin-bottom: 20px;
        }

        .dash-section:last-child {
            margin-bottom: 0;
        }

        .date-picker-container {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-picker-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .date-picker-input {
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .date-picker-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .time-tracking-widget {
            grid-column: 1 / -1;
        }

        .time-low-hours {
            color: #d32f2f;
            font-weight: 600;
        }

        .dash-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 15px;
            color: #1868DB;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #1868DB;
        }

        .dash-section-title .section-count {
            text-align: right;
            font-weight: 700;
        }

        .multi-dd {
            position: relative;
            min-width: 180px;
        }

        .multi-dd-btn {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background: #fff;
            color: #444;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
        }

        .multi-dd-btn:focus {
            outline: none;
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .multi-dd .caret {
            float: right;
            color: #888;
        }

        .multi-dd-options {
            position: absolute;
            z-index: 10;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            max-height: 220px;
            overflow: auto;
            padding: 8px 10px;
            display: none;
            pointer-events: auto;
        }

        .multi-dd-options.open {
            display: block;
        }

        .multi-dd-options label {
            display: block;
            font-size: 13px;
            color: #444;
            margin: 4px 0;
            cursor: pointer;
        }

        .multi-dd-options .dd-clear {
            margin-top: 8px;
            width: 100%;
            padding: 6px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .qa-col {
            min-width: 90px;
            white-space: nowrap;
        }

        .serial-col {
            width: 60px;
            text-align: center;
            white-space: nowrap;
        }

        .time-diff-positive {
            color: #d32f2f;
            font-weight: 600;
        }

        .time-diff-negative {
            color: #2e7d32;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <form class="controls" autocomplete="on" onsubmit="handleSubmit(event)">
            <div class="input-group">
                <label class="input-label" for="emailInput">Email</label>
                <input class="text-input" id="emailInput" name="email" type="email" autocomplete="username" placeholder="name@example.com">
            </div>
            <div class="input-group">
                <label class="input-label" for="tokenInput">Password</label>
                <input class="text-input" id="tokenInput" name="password" type="password" autocomplete="current-password" placeholder="Enter your password">
            </div>
            <button class="action-btn" type="submit" id="updateBtn">Fetch</button>
        </form>

        <div class="tab-bar">
            <button class="tab-btn active" id="tabLicensing" data-tab="licensing" onclick="switchTab('licensing')">Licensing</button>
            <button class="tab-btn" id="tabAssessments" data-tab="assessments" onclick="switchTab('assessments')">Assessments</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="error" id="error"></div>

        <div class="tickets-container" id="ticketsContainer">
            <div class="empty-state">
                <h2>No tickets loaded</h2>
                <p>Click the Fetch button after entering your email and password</p>
            </div>
        </div>
    </div>

    <script>
        // Add a timestamp to avoid caching issues
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWoFfWT42r0vwCgsJFkDGjI3b06OZlUHssujHLBNNsoQuJDcVTGHbDq-6g89lYezxNuw/exec';

        function updateStatus(message) {
            // Status display removed
        }

        let activeTab = 'licensing';
        let viewMode = 'table'; // 'table' | 'dashboard'
        let lastTickets = [];
        let sortField = null;
        let sortDir = 'asc';
        let openDropdown = null;
        const columns = [
            { id: 'serial', label: '#', sortable: null, className: 'serial-col' },
            { id: 'key', label: 'Key', sortable: 'key' },
            { id: 'summary', label: 'Summary', sortable: 'summary' },
            { id: 'status', label: 'Status', sortable: 'status' },
            { id: 'assignee', label: 'Assignee', sortable: 'assignee' },
            { id: 'priority', label: 'Priority', sortable: 'priority' },
            { id: 'storyPoints', label: 'Story Points', sortable: 'storyPoints' },
            { id: 'timeOriginalEstimate', label: 'Estimate', sortable: 'timeOriginalEstimate' },
            { id: 'actualHours', label: 'Time Spent', sortable: 'actualHours' },
            { id: 'timeDifference', label: 'Difference', sortable: 'timeDifference' },
            { id: 'created', label: 'Created', sortable: 'created' },
            { id: 'updated', label: 'Updated', sortable: 'updated' },
            { id: 'qaFailedCount', label: 'QA Loop', sortable: 'qaFailedCount', className: 'qa-col' },
        ];
        const columnVisibility = {
            serial: true,
            key: true,
            summary: false,
            status: true,
            assignee: true,
            priority: false,
            storyPoints: true,
            timeOriginalEstimate: true,
            actualHours: true,
            timeDifference: true,
            created: false,
            updated: false,
            qaFailedCount: true
        };
        const filters = {
            key: '',
            summary: '',
            statusValues: [],
            assigneeValues: [],
            priorityValues: [],
            storyPoints: '',
            timeOriginalEstimate: '',
            actualHours: '',
            timeDifference: '',
            created: '',
            updated: '',
            qaFailedCount: ''
        };

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('tabLicensing').classList.toggle('active', tab === 'licensing');
            document.getElementById('tabAssessments').classList.toggle('active', tab === 'assessments');
            hideError();
            showLoading(false);
            updateStatus('Enter email, password, then click Update');
            viewMode = 'table';
            updateDashboardButton();
            const container = document.getElementById('ticketsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <h2>No tickets loaded</h2>
                    <p>Select a tab and click fetch to load Jira tickets</p>
                </div>
            `;
            lastTickets = [];
        }

        function setFilter(field, value, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            filters[field] = value.toLowerCase();
            updateTableBody(lastTickets);
        }

        function setFilterMulti(field, selectEl, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            const values = Array.from(selectEl.selectedOptions || []).map(o => o.value.toLowerCase());
            filters[field] = values;
            updateTableBody(lastTickets);
        }

        function toggleDropdown(field, evt) {
            if (evt) evt.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (!dropdown) return;
            closeDropdowns(field);
            const willOpen = !dropdown.classList.contains('open');
            if (willOpen) {
                dropdown.classList.add('open');
                openDropdown = field;
            } else {
                dropdown.classList.remove('open');
                openDropdown = null;
            }
        }

        function closeDropdowns(exceptField) {
            document.querySelectorAll('.multi-dd-options').forEach(el => {
                if (exceptField && el.id === `dropdown-${exceptField}`) return;
                el.classList.remove('open');
            });
            if (!exceptField) openDropdown = null;
        }

        document.addEventListener('click', () => {
            closeDropdowns();
        });

        function toggleMultiOption(field, value, checked, evt) {
            if (evt) evt.stopPropagation();
            const key = `${field}Values`;
            const arr = filters[key] || [];
            const norm = value.toLowerCase();
            const exists = arr.includes(norm);
            if (checked && !exists) {
                arr.push(norm);
                filters[key] = arr;
            } else if (!checked && exists) {
                filters[key] = arr.filter(v => v !== norm);
            }
            renderTickets(lastTickets);
        }

        function dropdownLabel(field) {
            const arr = filters[`${field}Values`] || [];
            if (arr.length === 0) return 'All';
            if (arr.length === 1) return arr[0];
            return `${arr.length} selected`;
        }

        function columnsDropdownLabel() {
            const visibleCount = Object.values(columnVisibility).filter(Boolean).length;
            const total = columns.length;
            return visibleCount === total ? 'Columns (All)' : `Columns (${visibleCount}/${total})`;
        }

        function toggleColumnVisibility(colId, checked, evt) {
            if (evt) evt.stopPropagation();
            columnVisibility[colId] = checked;
            renderTickets(lastTickets);
        }

        function resetColumns(evt) {
            if (evt) evt.stopPropagation();
            Object.keys(columnVisibility).forEach(k => columnVisibility[k] = true);
            renderTickets(lastTickets);
        }

        function setSort(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }
            updateTableBody(lastTickets);
        }

        function sortIndicator(field) {
            if (sortField !== field) return '⇅';
            return sortDir === 'asc' ? '▲' : '▼';
        }

        function toggleDashboard() {
            viewMode = viewMode === 'dashboard' ? 'table' : 'dashboard';
            updateDashboardButton();
            renderTickets(lastTickets);
        }

        function updateWorklogDate(date) {
            window.selectedWorklogDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }
        }

        function updateDashboardButton() {
            const btn = document.getElementById('dashboardBtn');
            if (!btn) return;
            btn.textContent = viewMode === 'dashboard' ? 'Table View' : 'Dashboard';
        }

        function clearFilters() {
            filters.key = '';
            filters.summary = '';
            filters.statusValues = [];
            filters.assigneeValues = [];
            filters.priorityValues = [];
            filters.storyPoints = '';
            filters.timeOriginalEstimate = '';
            filters.actualHours = '';
            filters.timeDifference = '';
            filters.created = '';
            filters.updated = '';
            filters.qaFailedCount = '';
            renderTickets(lastTickets);
        }

        function getUniqueValues(tickets, field) {
            const set = new Set();
            (tickets || []).forEach(t => {
                const val = (t[field] || '').trim();
                if (val) set.add(val);
            });
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        }

        function applyFiltersAndSort(tickets) {
            const filtered = tickets.filter(t => {
                const key = (t.key || '').toLowerCase().includes(filters.key);
                const summary = (t.summary || t.title || '').toLowerCase().includes(filters.summary);

                const statusValue = (t.status || '').toLowerCase();
                const status = filters.statusValues.length === 0 || filters.statusValues.includes(statusValue);

                const assigneeValue = (t.assignee || '').toLowerCase();
                const assignee = filters.assigneeValues.length === 0 || filters.assigneeValues.includes(assigneeValue);

                const priorityValue = (t.priority || '').toLowerCase();
                const priority = filters.priorityValues.length === 0 || filters.priorityValues.includes(priorityValue);

                const storyPoints = String(typeof t.storyPoints === 'number' ? t.storyPoints : '').toLowerCase().includes(filters.storyPoints);
                const timeEstimate = formatTimeFromSeconds(t.timeOriginalEstimate || 0).toLowerCase().includes(filters.timeOriginalEstimate);
                const actualHrs = formatTimeFromSeconds(t.actualHours || 0).toLowerCase().includes(filters.actualHours);
                // For timeDifference, calculate the difference and format for filtering (without HTML)
                const estimateSeconds = typeof t.timeOriginalEstimate === 'number' ? t.timeOriginalEstimate : 0;
                const actualSeconds = typeof t.actualHours === 'number' ? t.actualHours : 0;
                const diffSeconds = actualSeconds - estimateSeconds;
                const timeDiffFormatted = diffSeconds !== 0 ? (diffSeconds > 0 ? '+' : '-') + formatTimeFromSeconds(Math.abs(diffSeconds)) : '';
                const timeDiff = timeDiffFormatted.toLowerCase().includes(filters.timeDifference);
                const created = (t.created || '').toLowerCase().includes(filters.created);
                const updated = (t.updated || '').toLowerCase().includes(filters.updated);
                const qaFailed = String(typeof t.qaFailedCount === 'number' ? t.qaFailedCount : '').toLowerCase().includes(filters.qaFailedCount);
                return key && summary && status && assignee && priority && storyPoints && timeEstimate && actualHrs && timeDiff && created && updated && qaFailed;
            });

            if (!sortField) return filtered;

            const dir = sortDir === 'asc' ? 1 : -1;
            return filtered.slice().sort((a, b) => {
                // Handle numeric fields (storyPoints, qaFailedCount, timeOriginalEstimate, actualHours, timeDifference)
                if (sortField === 'storyPoints' || sortField === 'qaFailedCount' || sortField === 'timeOriginalEstimate' || sortField === 'actualHours' || sortField === 'timeDifference') {
                    let va, vb;
                    if (sortField === 'timeDifference') {
                        // Calculate difference for sorting
                        va = (typeof a.actualHours === 'number' ? a.actualHours : 0) - (typeof a.timeOriginalEstimate === 'number' ? a.timeOriginalEstimate : 0);
                        vb = (typeof b.actualHours === 'number' ? b.actualHours : 0) - (typeof b.timeOriginalEstimate === 'number' ? b.timeOriginalEstimate : 0);
                    } else {
                        va = typeof a[sortField] === 'number' ? a[sortField] : 0;
                        vb = typeof b[sortField] === 'number' ? b[sortField] : 0;
                    }
                    return (va - vb) * dir;
                }
                // Handle string fields
                const va = (a[sortField] ?? '').toString().toLowerCase();
                const vb = (b[sortField] ?? '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
        }

        function updateTableBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderTickets(tickets);
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const visible = applyFiltersAndSort(tickets || []);
            tbody.innerHTML = visible.map((ticket, idx) => {
                const cells = [];
                if (columnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (columnVisibility.key) cells.push(`<td>${ticket.key || 'N/A'}</td>`);
                if (columnVisibility.summary) cells.push(`<td>${ticket.summary || ticket.title || 'No title'}</td>`);
                if (columnVisibility.status) cells.push(`<td><span class="ticket-status">${ticket.status || 'Unknown'}</span></td>`);
                if (columnVisibility.assignee) cells.push(`<td>${ticket.assignee || ''}</td>`);
                if (columnVisibility.priority) cells.push(`<td>${ticket.priority || ''}</td>`);
                if (columnVisibility.storyPoints) cells.push(`<td>${typeof ticket.storyPoints === 'number' ? ticket.storyPoints : ''}</td>`);
                if (columnVisibility.timeOriginalEstimate) cells.push(`<td>${formatTimeFromSeconds(ticket.timeOriginalEstimate || 0)}</td>`);
                if (columnVisibility.actualHours) cells.push(`<td>${formatTimeFromSeconds(ticket.actualHours || 0)}</td>`);
                if (columnVisibility.timeDifference) cells.push(`<td>${formatTimeDifference(ticket.timeOriginalEstimate, ticket.actualHours)}</td>`);
                if (columnVisibility.created) cells.push(`<td>${ticket.created ? formatDate(ticket.created) : ''}</td>`);
                if (columnVisibility.updated) cells.push(`<td>${ticket.updated ? formatDate(ticket.updated) : ''}</td>`);
                if (columnVisibility.qaFailedCount) cells.push(`<td>${typeof ticket.qaFailedCount === 'number' ? ticket.qaFailedCount : ''}</td>`);
                return `<tr onclick="window.open('${ticket.url || '#'}', '_blank')" style="cursor:pointer;">${cells.join('')}</tr>`;
            }).join('');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('active');
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('done') || statusLower.includes('closed') || statusLower.includes('resolved')) {
                return 'status-done';
            } else if (statusLower.includes('progress')) {
                return 'status-in-progress';
            } else if (statusLower.includes('todo') || statusLower.includes('open') || statusLower.includes('backlog')) {
                return 'status-todo';
            }
            return 'status-default';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatTimeFromSeconds(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';
            
            // Custom conversions: 60m = 1h, 8h = 1d, 5d = 1w
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600
            const SECONDS_PER_DAY = 8 * SECONDS_PER_HOUR; // 28800 (8 hours = 1 day)
            const SECONDS_PER_WEEK = 5 * SECONDS_PER_DAY; // 144000 (5 days = 1 week)
            
            const weeks = Math.floor(seconds / SECONDS_PER_WEEK);
            const days = Math.floor((seconds % SECONDS_PER_WEEK) / SECONDS_PER_DAY);
            const hours = Math.floor((seconds % SECONDS_PER_DAY) / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);
            
            const parts = [];
            if (weeks > 0) parts.push(`${weeks}w`);
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeHoursMinutes(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';
            
            // Standard conversions: 60m = 1h (no days or weeks)
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600
            
            const hours = Math.floor(seconds / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeDifference(estimate, actual) {
            if (estimate === null || estimate === undefined || actual === null || actual === undefined) {
                return '';
            }
            
            const estimateSeconds = typeof estimate === 'number' ? estimate : 0;
            const actualSeconds = typeof actual === 'number' ? actual : 0;
            const difference = actualSeconds - estimateSeconds;
            
            if (difference === 0) {
                return '';
            }
            
            const absDifference = Math.abs(difference);
            const formatted = formatTimeFromSeconds(absDifference);
            
            if (difference > 0) {
                return `<span class="time-diff-positive">+${formatted}</span>`;
            } else {
                return `<span class="time-diff-negative">-${formatted}</span>`;
            }
        }

        function getStatusCategory(status) {
            const statusLower = status.toLowerCase().trim();
            const devStatuses = ['dev in progress', 'qa failed', 'ready for dev', 'dev complete', 'bug fixes - dev'];
            const qaStatuses = ['ready to review', 'qa in progress', 'review failed'];
            const baStatuses = ['review completed', 'qa complete', 'ba review'];
            const doneStatuses = ['done'];

            if (devStatuses.some(s => statusLower === s)) {
                return 'Dev';
            }
            if (qaStatuses.some(s => statusLower === s)) {
                return 'QA';
            }
            if (baStatuses.some(s => statusLower === s)) {
                return 'BA';
            }
            if (doneStatuses.some(s => statusLower === s)) {
                return 'Done';
            }
            return 'Other';
        }

        function getWorklogsByDate(tickets, selectedDate) {
            if (!selectedDate) return {};
            
            const assigneeTimeMap = {};
            // selectedDate is in YYYY-MM-DD format
            const selectedDateStr = selectedDate;
            
            tickets.forEach(ticket => {
                if (!ticket.worklog || !ticket.worklog.worklogs) return;
                
                ticket.worklog.worklogs.forEach(worklog => {
                    if (!worklog.started || !worklog.timeSpentSeconds || !worklog.author) return;
                    
                    // Parse the started date - format: "2025-12-11T14:00:00.000+0530"
                    // Extract just the date part (YYYY-MM-DD) from the ISO string
                    const worklogDateStr = worklog.started.split('T')[0];
                    
                    // Check if worklog is for the selected date
                    if (worklogDateStr === selectedDateStr) {
                        const assigneeName = worklog.author.displayName || 'Unknown';
                        const timeSpent = worklog.timeSpentSeconds || 0;
                        
                        if (!assigneeTimeMap[assigneeName]) {
                            assigneeTimeMap[assigneeName] = 0;
                        }
                        assigneeTimeMap[assigneeName] += timeSpent;
                    }
                });
            });
            
            return assigneeTimeMap;
        }

        function renderDashboard(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            const statusCounts = {};
            const assigneeCounts = {};
            const totalTickets = tickets.length;
            tickets.forEach(t => {
                const status = (t.status || 'Unknown').trim();
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                const assignee = (t.assignee || 'Unassigned').trim();
                assigneeCounts[assignee] = (assigneeCounts[assignee] || 0) + 1;
            });

            // Group statuses by category
            const statusByCategory = {
                'Dev': [],
                'QA': [],
                'BA': [],
                'Done': [],
                'Other': []
            };

            Object.entries(statusCounts).forEach(([status, count]) => {
                const category = getStatusCategory(status);
                statusByCategory[category].push({ status, count });
            });

            // Sort statuses within each category by count (descending)
            Object.keys(statusByCategory).forEach(category => {
                statusByCategory[category].sort((a, b) => b.count - a.count);
            });

            // Calculate section totals
            const sectionTotals = {};
            Object.keys(statusByCategory).forEach(category => {
                sectionTotals[category] = statusByCategory[category].reduce((sum, { count }) => sum + count, 0);
            });

            // Render status sections
            const sectionOrder = ['Dev', 'QA', 'BA', 'Done', 'Other'];
            const statusSections = sectionOrder.map(category => {
                const statuses = statusByCategory[category];
                if (statuses.length === 0) return '';

                const sectionTotal = sectionTotals[category];
                const sectionPercentage = totalTickets > 0 ? ((sectionTotal / totalTickets) * 100).toFixed(1) : '0.0';

                const statusItems = statuses.map(({ status, count }) => {
                    const percentage = totalTickets > 0 ? ((count / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                }).join('');

                return `
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>${category}</span>
                            <span class="section-count">${sectionTotal} (${sectionPercentage}%)</span>
                        </div>
                        <ul class="dash-list">
                            ${statusItems}
                        </ul>
                    </div>
                `;
            }).filter(section => section !== '').join('');

            const assigneeList = Object.entries(assigneeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalTickets > 0 ? ((v / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${v} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate QA Loop count breakdown
            const qaFailedCounts = {};
            tickets.forEach(t => {
                const count = typeof t.qaFailedCount === 'number' ? t.qaFailedCount : 0;
                qaFailedCounts[count] = (qaFailedCounts[count] || 0) + 1;
            });

            const qaFailedList = Object.entries(qaFailedCounts)
                .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                .map(([count, ticketCount]) => {
                    const percentage = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${count}</span><span>${ticketCount} (${percentage}%)</span></li>`;
                })
                .join('');

            // Get today's date in YYYY-MM-DD format for default date picker (using local date)
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Get worklogs for selected date (default to today)
            const selectedDate = window.selectedWorklogDate || todayStr;
            
            // Initialize window.selectedWorklogDate if not set
            if (!window.selectedWorklogDate) {
                window.selectedWorklogDate = todayStr;
            }
            const assigneeTimeMap = getWorklogsByDate(tickets, selectedDate);
            
            // Get all unique assignees from tickets and merge with worklog data
            // This ensures all assignees are shown, even if they have 0 logged hours
            const allAssigneesMap = {};
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                if (assignee && !allAssigneesMap[assignee]) {
                    allAssigneesMap[assignee] = assigneeTimeMap[assignee] || 0;
                }
            });
            
            // Sort assignees by time spent (descending)
            // 8 hours = 8 * 3600 = 28800 seconds
            const EIGHT_HOURS_IN_SECONDS = 8 * 3600;
            const assigneeTimeList = Object.entries(allAssigneesMap)
                .sort((a, b) => b[1] - a[1])
                .map(([assignee, totalSeconds]) => {
                    const formatted = formatTimeHoursMinutes(totalSeconds);
                    // Apply red color if less than 8 hours
                    const timeClass = totalSeconds < EIGHT_HOURS_IN_SECONDS ? 'time-low-hours' : '';
                    return `<li><span>${assignee}</span><span class="${timeClass}">${formatted}</span></li>`;
                })
                .join('');
            
            const totalTimeSpent = Object.values(allAssigneesMap).reduce((sum, seconds) => sum + seconds, 0);
            const totalFormatted = formatTimeHoursMinutes(totalTimeSpent);

            container.innerHTML = `
                <div class="filter-actions">
                    <button class="clear-btn" type="button" onclick="toggleDashboard()">Table View</button>
                </div>
                <div class="dash-grid">
                    <div class="dash-card">
                        <h3>Status</h3>
                        ${statusSections || '<div class="dash-section"><div class="dash-section-title">Other</div><ul class="dash-list"><li><span>None</span><span>0 (0.0%)</span></li></ul></div>'}
                    </div>
                    <div class="dash-card">
                        <h3>Assignee</h3>
                        <ul class="dash-list">
                            ${assigneeList || '<li><span>None</span><span>0 (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card">
                        <h3>QA Loop</h3>
                        <ul class="dash-list">
                            ${qaFailedList || '<li><span>0</span><span>0 tickets (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card time-tracking-widget">
                        <h3>Assignee Time Tracking</h3>
                        <div class="date-picker-container">
                            <label class="date-picker-label" for="worklogDatePicker">Date:</label>
                            <input type="date" id="worklogDatePicker" class="date-picker-input" value="${selectedDate}" onchange="updateWorklogDate(this.value)">
                        </div>
                        <div class="dash-section">
                            <div class="dash-section-title">
                                <span>Total Time</span>
                                <span class="section-count">${totalFormatted}</span>
                            </div>
                        </div>
                        <ul class="dash-list">
                            ${assigneeTimeList || '<li><span>No time logged</span><span>0m</span></li>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderTickets(tickets) {
            lastTickets = tickets || [];
            const container = document.getElementById('ticketsContainer');
            container.classList.remove('grid-mode');
            
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            if (viewMode === 'dashboard') {
                renderDashboard(tickets);
                return;
            }

            const visibleTickets = applyFiltersAndSort(tickets);

            {
                const statusOptions = getUniqueValues(tickets, 'status');
                const assigneeOptions = getUniqueValues(tickets, 'assignee');
                const priorityOptions = getUniqueValues(tickets, 'priority');

                const optionHtml = (opts, selected, field) => opts.map(opt => {
                    const isSel = selected.includes(opt.toLowerCase());
                    const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    return `
                        <label>
                            <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleMultiOption('${field}', '${safe}', this.checked, event)">
                            ${safe}
                        </label>
                    `;
                }).join('');

                const visibleColumns = columns.filter(c => columnVisibility[c.id]);

                const headerCells = visibleColumns.map(col => {
                    const sortableAttrs = col.sortable
                        ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setSort('${col.id}')"`
                        : `${col.className ? `class="${col.className}"` : ''}`;
                    const indicator = col.sortable ? `<span class="sort-indicator">${sortIndicator(col.id)}</span>` : '';
                    return `
                        <th ${sortableAttrs}>
                            ${col.label} ${indicator}
                        </th>
                    `;
                }).join('');

                const filterRow = `
                    <tr>
                        ${visibleColumns.map(col => {
                            if (col.id === 'serial') {
                                return `<th class="serial-col">#</th>`;
                            }
                            if (col.id === 'key') {
                                return `<th><input type="text" placeholder="Search key" oninput="setFilter('key', this.value, event)" onclick="event.stopPropagation();" value="${filters.key || ''}"></th>`;
                            }
                            if (col.id === 'summary') {
                                return `<th><input type="text" placeholder="Search summary" oninput="setFilter('summary', this.value, event)" onclick="event.stopPropagation();" value="${filters.summary || ''}"></th>`;
                            }
                            if (col.id === 'status') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-status" type="button" onclick="toggleDropdown('status', event)">
                                                ${dropdownLabel('status')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-status">
                                                ${optionHtml(statusOptions, filters.statusValues, 'status')}
                                                <button class="dd-clear" type="button" onclick="filters.statusValues=[]; renderTickets(lastTickets); event.stopPropagation();">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'assignee') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-assignee" type="button" onclick="toggleDropdown('assignee', event)">
                                                ${dropdownLabel('assignee')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-assignee">
                                                ${optionHtml(assigneeOptions, filters.assigneeValues, 'assignee')}
                                                <button class="dd-clear" type="button" onclick="filters.assigneeValues=[]; renderTickets(lastTickets); event.stopPropagation();">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'priority') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-priority" type="button" onclick="toggleDropdown('priority', event)">
                                                ${dropdownLabel('priority')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-priority">
                                                ${optionHtml(priorityOptions, filters.priorityValues, 'priority')}
                                                <button class="dd-clear" type="button" onclick="filters.priorityValues=[]; renderTickets(lastTickets); event.stopPropagation();">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'storyPoints') {
                                return `<th><input type="text" placeholder="Search story points" oninput="setFilter('storyPoints', this.value, event)" onclick="event.stopPropagation();" value="${filters.storyPoints || ''}"></th>`;
                            }
                            if (col.id === 'timeOriginalEstimate') {
                                return `<th><input type="text" placeholder="Search estimate" oninput="setFilter('timeOriginalEstimate', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeOriginalEstimate || ''}"></th>`;
                            }
                            if (col.id === 'actualHours') {
                                return `<th><input type="text" placeholder="Search time spent" oninput="setFilter('actualHours', this.value, event)" onclick="event.stopPropagation();" value="${filters.actualHours || ''}"></th>`;
                            }
                            if (col.id === 'timeDifference') {
                                return `<th><input type="text" placeholder="Search difference" oninput="setFilter('timeDifference', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeDifference || ''}"></th>`;
                            }
                            if (col.id === 'created') {
                                return `<th><input type="text" placeholder="Search created" oninput="setFilter('created', this.value, event)" onclick="event.stopPropagation();" value="${filters.created || ''}"></th>`;
                            }
                            if (col.id === 'updated') {
                                return `<th><input type="text" placeholder="Search updated" oninput="setFilter('updated', this.value, event)" onclick="event.stopPropagation();" value="${filters.updated || ''}"></th>`;
                            }
                            if (col.id === 'qaFailedCount') {
                                return `<th class="qa-col"><input type="text" placeholder="Search QA loop" oninput="setFilter('qaFailedCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.qaFailedCount || ''}"></th>`;
                            }
                            return '<th></th>';
                        }).join('')}
                    </tr>
                `;

                const columnChooser = `
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-columns" type="button" onclick="toggleDropdown('columns', event)">
                            ${columnsDropdownLabel()} <span class="caret">▾</span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-columns">
                            ${columns.map(col => `
                                <label>
                                    <input type="checkbox" ${columnVisibility[col.id] ? 'checked' : ''} onchange="toggleColumnVisibility('${col.id}', this.checked, event)">
                                    ${col.label}
                                </label>
                            `).join('')}
                            <button class="dd-clear" type="button" onclick="resetColumns(event)">Show all</button>
                        </div>
                    </div>
                `;

                container.innerHTML = `
                    <div class="filter-actions">
                        ${columnChooser}
                        <button class="clear-btn" type="button" id="dashboardBtn" onclick="toggleDashboard()">Dashboard</button>
                        <button class="clear-btn" type="button" onclick="clearFilters()">Clear filters</button>
                    </div>
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                ${headerCells}
                            </tr>
                            ${filterRow}
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                updateTableBody(tickets);
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card" onclick="window.open('${ticket.url || '#'}', '_blank')">
                    <div class="ticket-header">
                        <span class="ticket-key">${ticket.key || 'N/A'}</span>
                        <span class="ticket-status ${getStatusClass(ticket.status || '')}">
                            ${ticket.status || 'Unknown'}
                        </span>
                    </div>
                    <div class="ticket-title">${ticket.summary || ticket.title || 'No title'}</div>
                    <div class="ticket-meta">
                        ${ticket.assignee ? `<div class="ticket-meta-item">👤 ${ticket.assignee}</div>` : ''}
                        ${ticket.priority ? `<div class="ticket-meta-item">⚡ ${ticket.priority}</div>` : ''}
                        ${ticket.created ? `<div class="ticket-meta-item">📅 Created: ${formatDate(ticket.created)}</div>` : ''}
                        ${ticket.updated ? `<div class="ticket-meta-item">🔄 Updated: ${formatDate(ticket.updated)}</div>` : ''}
                        ${typeof ticket.qaFailedCount === 'number' ? `<div class="ticket-meta-item">❗ QA Loop: ${ticket.qaFailedCount}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function handleSubmit(event) {
            event.preventDefault();
            loadTickets();
        }

        async function loadTickets() {
            const updateBtn = document.getElementById('updateBtn');
            const email = document.getElementById('emailInput').value.trim();
            const apiToken = document.getElementById('tokenInput').value.trim();
            const container = document.getElementById('ticketsContainer');

            if (!email || !apiToken) {
                showError('Please enter your email and password.');
                updateStatus('Missing credentials');
                return;
            }

            updateBtn.disabled = true;
            showLoading(true);
            hideError();
            updateStatus('Loading tickets...');

            try {
                const parent = activeTab === 'assessments' ? 'EM-1460' : 'EM-896';
                const formBody = new URLSearchParams({ email, apiToken, parent }).toString();
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formBody
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const tickets = data.tickets || data.issues || data;
                const normalized = Array.isArray(tickets) ? tickets : [tickets];
                renderTickets(normalized);
                updateStatus(`Loaded ${normalized.length} ticket(s)`);
            } catch (error) {
                console.error('Error loading tickets:', error);
                showError(`Error loading tickets: ${error.message}`);
                updateStatus('Error loading tickets');
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets loaded</h2>
                        <p>Update failed. Please check your credentials and try again.</p>
                    </div>
                `;
            } finally {
                showLoading(false);
                updateBtn.disabled = false;
            }
        }

        // Do not auto-load; user triggers via Update button
    </script>
</body>
</html>

